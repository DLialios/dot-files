#!/bin/bash
# requires GNU bc

# < 50 degrees fan is at 50
# 50 degrees fan is at 50
# 60 degrees fan is at 70
# 74 degrees fan is at 100

nvidia-settings -a [gpu:0]/GPUGraphicsClockOffsetAllPerformanceLevels=160 > /dev/null 2>&1
nvidia-settings -a [gpu:0]/GPUMemoryTransferRateOffsetAllPerformanceLevels=1000 > /dev/null 2>&1
nvidia-settings -a [gpu:0]/GPUFanControlState=1 > /dev/null 2>&1

while :
do
	t=$(nvidia-settings -q [thermalsensor:0]/ThermalSensorReading | sed -n '2p')
	t=${t##*:}
	t=${t//[!0-9]/}
	if [ $t -lt 50 ]
	then
		s=50
	elif [ $t -gt 74 ]
	then
		s=100
	else
		s=$(printf %.0f $(bc -l <<< "(0.005952380952387 * $t * $t) + (1.34523809523773 * $t) - 32.142857142854"))
	fi
	nvidia-settings -a [fan:0]/GPUTargetFanSpeed=$s > /dev/null 2>&1
	sleep 3
done
